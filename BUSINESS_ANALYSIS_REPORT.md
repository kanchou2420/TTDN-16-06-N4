# B√ÅO C√ÅO PH√ÇN T√çCH NGHI·ªÜP V·ª§ - H·ªÜ TH·ªêNG QU·∫¢N L√ù T√ÄI CH√çNH H√Ä H√ÄNH CH√çNH

**Ng√†y ph√¢n t√≠ch:** 21/01/2026  
**Phi√™n b·∫£n:** 1.0  
**Ph√¢n t√≠ch b·ªüi:** Business Analyst & Software Engineer  

---

## I. T·ªîNG QUAN H·ªÜ TH·ªêNG

### 1.1 C√°c Module Ch√≠nh
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ H·ªÜ TH·ªêNG QU·∫¢N L√ù T√ÄI CH√çNH & H√ÄNH CH√çNH                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ Qu·∫£n L√Ω Ng√¢n S√°ch ‚îÇ  ‚îÇQu·∫£n L√Ω T√†i S·∫£n   ‚îÇ  ‚îÇQu·∫£n L√Ω VƒÉn B·∫£n‚îÇ ‚îÇ
‚îÇ  ‚îÇ (quan_ly_ngan_sach)‚îÇ (quan_ly_tai_san) ‚îÇ  ‚îÇ(quan_ly_van_ban)‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ           ‚ñ≤                      ‚ñ≤                   ‚ñ≤            ‚îÇ
‚îÇ           ‚îÇ                      ‚îÇ                   ‚îÇ            ‚îÇ
‚îÇ           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îÇ                                  ‚îÇ                                ‚îÇ
‚îÇ                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îÇ
‚îÇ                   ‚ñº                             ‚ñº                ‚îÇ
‚îÇ           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
‚îÇ           ‚îÇ Thu Chi & C√¥ng N·ª£‚îÇ        ‚îÇ  Nh√¢n S·ª±         ‚îÇ      ‚îÇ
‚îÇ           ‚îÇ(quanly_thuchi_   ‚îÇ        ‚îÇ  (nhan_su)       ‚îÇ      ‚îÇ
‚îÇ           ‚îÇ congno)          ‚îÇ        ‚îÇ  [External]      ‚îÇ      ‚îÇ
‚îÇ           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
‚îÇ                                                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 1.2 M√¥ t·∫£ T√≥m T·∫Øt

| Module | Ch·ª©c NƒÉng Ch√≠nh | Tr·∫°ng Th√°i Code |
|--------|-----------------|-----------------|
| **Qu·∫£n L√Ω Ng√¢n S√°ch** | L·∫≠p KH ng√¢n s√°ch, ph√¢n b·ªï, theo d√µi th·ª±c hi·ªán | ‚úÖ C·∫•u tr√∫c t·ªët |
| **Qu·∫£n L√Ω T√†i S·∫£n** | Qu·∫£n l√Ω t√†i s·∫£n, kh·∫•u hao, lu√¢n chuy·ªÉn, thanh l√Ω | ‚úÖ Chi ti·∫øt |
| **Qu·∫£n L√Ω VƒÉn B·∫£n** | Qu·∫£n l√Ω vƒÉn b·∫£n ƒëi/ƒë·∫øn | ‚ö†Ô∏è Qu√° ƒë∆°n gi·∫£n |
| **Thu Chi & C√¥ng N·ª£** | Phi·∫øu thu/chi, theo d√µi c√¥ng n·ª£ | ‚úÖ T∆∞∆°ng ƒë·ªëi ƒë·∫ßy ƒë·ªß |

---

## II. PH√ÇN T√çCH CHI TI·∫æT T·ª™NG MODULE

### 2.1 MODULE: QU·∫¢N L√ù NG√ÇN S√ÅCH (quan_ly_ngan_sach)

#### 2.1.1 C·∫•u Tr√∫c Models
```
ngan_sach (Ng√¢n S√°ch)
‚îú‚îÄ‚îÄ du_toan_chi (D·ª± To√°n Chi)
‚îú‚îÄ‚îÄ phan_bo_ngan_sach (Ph√¢n B·ªï Ng√¢n S√°ch)
‚îî‚îÄ‚îÄ theo_doi_thuc_hien_ngan_sach (Theo D√µi Th·ª±c Hi·ªán)
```

#### 2.1.2 Ph√¢n T√≠ch Logic Ch√≠nh

**‚úÖ ƒêi·ªÉm T·ªët:**
1. Ph√¢n lo·∫°i ng√¢n s√°ch r√µ r√†ng (nƒÉm, qu√Ω, th√°ng, d·ª± √°n)
2. C√≥ r√†ng bu·ªôc d·ªØ li·ªáu (unique ma_ngan_sach, ki·ªÉm tra ng√†y)
3. Theo d√µi ng∆∞·ªùi l·∫≠p, ng∆∞·ªùi duy·ªát
4. T√≠nh to√°n t·ª± ƒë·ªông: t·ªïng ph√¢n b·ªï, c√≤n l·∫°i

**‚ö†Ô∏è V·∫§N ƒê·ªÄ PH√ÅT HI·ªÜN:**

| # | V·∫•n ƒê·ªÅ | M·ª©c ƒê·ªô | ·∫¢nh H∆∞·ªüng |
|---|--------|--------|----------|
| 1 | Kh√¥ng c√≥ tr∆∞·ªùng `description` ƒë·ªÉ gi·∫£i th√≠ch ng√¢n s√°ch | Th·∫•p | D·ªÖ hi·ªÉu sai |
| 2 | Kh√¥ng c√≥ s·ªë ti·ªÅn chi ti·∫øt theo d·ª± to√°n trong ng√¢n s√°ch | Cao | Kh√¥ng theo d√µi ƒë∆∞·ª£c chi ti√™u th·ª±c t·∫ø so v·ªõi k·∫ø ho·∫°ch |
| 3 | Thi·∫øu ph√©p t√≠nh: "ƒê√£ chi th·ª±c t·∫ø" vs "D·ª± to√°n chi ƒë∆∞·ª£c duy·ªát" | Cao | Kh√¥ng bi·∫øt v∆∞·ª£t hay ti·∫øt ki·ªám ƒë∆∞·ª£c bao nhi√™u |
| 4 | Tr∆∞·ªùng `quy`, `thang` kh√¥ng b·∫Øt bu·ªôc khi lo·∫°i_ngan_sach = 'quy'/'thang' | Cao | D·ªØ li·ªáu kh√¥ng nh·∫•t qu√°n |
| 5 | Kh√¥ng c√≥ ki·ªÉm tra: t·ªïng phan_bo kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t tong_ngan_sach | Cao | C√≥ th·ªÉ ph√¢n b·ªï qu√° m·ª©c |
| 6 | Kh√¥ng l∆∞u l·ªãch s·ª≠ thay ƒë·ªïi tr·∫°ng th√°i (khi n√†o duy·ªát, h·ªßy) | Trung | Kh√≥ audit |
| 7 | Kh√¥ng c√≥ li√™n k·∫øt tr·ª±c ti·∫øp t·ªõi phi·∫øu chi ƒë·ªÉ ki·ªÉm tra v∆∞·ª£t ng√¢n s√°ch | Cao | Kh√¥ng c·∫£nh b√°o khi chi v∆∞·ª£t |

**üî¥ LOGIC L·ªñI TRONG D·ª∞ TO√ÅN CHI:**
- D·ª± to√°n chi c√≥ 2 tr∆∞·ªùng ti·ªÅn: `so_tien_du_kien` vs `so_tien_duyet`
- Nh∆∞ng **kh√¥ng c√≥ tr∆∞·ªùng l∆∞u "ƒë√£ chi th·ª±c t·∫ø"** ‚Üí kh√¥ng bi·∫øt t√¨nh tr·∫°ng th·ª±c hi·ªán
- Tr·∫°ng th√°i = 'hoan_thanh' nh∆∞ng kh√¥ng ki·ªÉm tra ƒë√£ chi h·∫øt ch∆∞a

---

### 2.2 MODULE: QU·∫¢N L√ù T√ÄI S·∫¢N (quan_ly_tai_san)

#### 2.2.1 C·∫•u Tr√∫c Models
```
tai_san (T√†i S·∫£n)
‚îú‚îÄ‚îÄ danh_muc_tai_san (Danh M·ª•c)
‚îú‚îÄ‚îÄ phan_bo_tai_san (Ph√¢n B·ªï)
‚îú‚îÄ‚îÄ lich_su_khau_hao (L·ªãch S·ª≠ Kh·∫•u Hao)
‚îú‚îÄ‚îÄ kich_ke_tai_san (Ki·ªÉm K√™)
‚îú‚îÄ‚îÄ luan_chuyen_tai_san (Lu√¢n Chuy·ªÉn)
‚îú‚îÄ‚îÄ thanh_ly_tai_san (Thanh L√Ω)
‚îî‚îÄ‚îÄ lich_su_ky_thuat (L·ªãch S·ª≠ K·ªπ Thu·∫≠t)
```

#### 2.2.2 Ph√¢n T√≠ch

**‚úÖ ƒêi·ªÉm T·ªët:**
1. Chi ti·∫øt t√†i s·∫£n: gi√° tr·ªã, kh·∫•u hao, l·ªãch s·ª≠ s·ª≠ d·ª•ng
2. Theo d√µi nhi·ªÅu kh√≠a c·∫°nh: k·ªπ thu·∫≠t, kh·∫•u hao, ki·ªÉm k√™, lu√¢n chuy·ªÉn
3. H√¨nh ·∫£nh & gi·∫•y t·ªù li√™n quan
4. T√≠nh tr·∫°ng th√°i t·ª± ƒë·ªông (chua_phan_bo, da_phan_bo, da_thanh_ly)

**‚ö†Ô∏è V·∫§N ƒê·ªÄ:**

| # | V·∫•n ƒê·ªÅ | M·ª©c ƒê·ªô | 
|---|--------|--------|
| 1 | **THI·∫æU LI√äN K·∫æT NG√ÇN S√ÅCH:** Kh√¥ng l∆∞u t√†i s·∫£n ƒë∆∞·ª£c mua t·ª´ d·ª± to√°n/phi·∫øu chi n√†o | Cao |
| 2 | **THI·∫æU LI√äN K·∫æT THU CHI:** Kh√¥ng li√™n k·∫øt phi·∫øu chi (mua) v√† phi·∫øu thu (thanh l√Ω) | Cao |
| 3 | Kh·∫•u hao t√≠nh sai: `gia_tri_hien_tai` nh·∫≠p th·ªß c√¥ng, kh√¥ng t√≠nh t·ª± ƒë·ªông theo c√¥ng th·ª©c | Cao |
| 4 | Kh√¥ng c√≥ tr∆∞·ªùng theo d√µi "t√¨nh tr·∫°ng" (ho·∫°t ƒë·ªông, b·∫£o d∆∞·ª°ng, h·ªèng, thanh l√Ω) | Trung |
| 5 | Kh√¥ng ki·ªÉm tra: gi√° tr·ªã hi·ªán t·∫°i ‚â• 0 | Trung |
| 6 | `don_vi_tinh` l√† Char, kh√¥ng li√™n k·∫øt t·ªõi b·∫£ng danh m·ª•c | Th·∫•p |

**üî¥ BUG LOGIC:**
```python
# D√≤ng 55-60: T√≠nh tr·∫°ng th√°i nh∆∞ng logic sai
@api.depends('thanh_ly_ids', 'phong_ban_su_dung_ids')
def _compute_trang_thai_thanh_ly(self):
    # N·∫øu thanh_ly_ids > 0 ‚Üí 'da_thanh_ly' ‚úÖ
    # Elif phong_ban_su_dung_ids > 0 ‚Üí 'da_phan_bo' ‚úÖ
    # Else ‚Üí 'chua_phan_bo' ‚ùå (nh∆∞ng t√†i s·∫£n m·ªõi v√†o kho c≈©ng c√≥ tr·∫°ng th√°i n√†y)
```

---

### 2.3 MODULE: QU·∫¢N L√ù VƒÇN B·∫¢N (quan_ly_van_ban)

#### 2.3.1 Ph√¢n T√≠ch

**üî¥ V·∫§N ƒê·ªÄ NGHI√äM TR·ªåNG:**

VƒÉn b·∫£n ƒëi hi·ªán t·∫°i ch·ªâ c√≥ 1 tr∆∞·ªùng: `ten_van_ban`

**Thi·∫øu c√°c tr∆∞·ªùng quan tr·ªçng:**
- M√£ vƒÉn b·∫£n (unique)
- Ng√†y ban h√†nh / Ng√†y hi·ªáu l·ª±c
- Ng∆∞·ªùi k√Ω / Ng∆∞·ªùi ph√™ duy·ªát
- Ph√≤ng ban li√™n quan / ƒê·ªëi t√°c li√™n quan
- Tr·∫°ng th√°i (Nh√°p, Ban h√†nh, H·ªßy)
- N·ªôi dung / File ƒë√≠nh k√®m
- Ph√¢n lo·∫°i vƒÉn b·∫£n (Th√¥ng b√°o, Quy·∫øt ƒë·ªãnh, H·ª£p ƒë·ªìng, v.v)

**Thi·∫øu li√™n k·∫øt:**
- ‚ùå Kh√¥ng li√™n k·∫øt v·ªõi ph√≤ng ban / nh√¢n vi√™n
- ‚ùå Kh√¥ng li√™n k·∫øt v·ªõi d·ª± √°n / ho·∫°t ƒë·ªông
- ‚ùå Kh√¥ng li√™n k·∫øt v·ªõi ng√¢n s√°ch / t√†i s·∫£n khi l√† quy·∫øt ƒë·ªãnh ph√™ duy·ªát

---

### 2.4 MODULE: QU·∫¢N L√ù THU CHI & C√îNG N·ª¢ (quanly_thuchi_congno)

#### 2.4.1 C·∫•u Tr√∫c
```
phieu_thu (Phi·∫øu Thu)
phieu_chi (Phi·∫øu Chi)
‚îú‚îÄ‚îÄ cong_no_phai_thu (C√¥ng N·ª£ Ph·∫£i Thu)
‚îî‚îÄ‚îÄ cong_no_phai_tra (C√¥ng N·ª£ Ph·∫£i Tr·∫£) [Ch∆∞a th·∫•y model n√†y]
```

#### 2.4.2 Ph√¢n T√≠ch Phi·∫øu Chi

**‚úÖ ƒêi·ªÉm T·ªët:**
1. Li√™n k·∫øt c√¥ng n·ª£, ng√¢n s√°ch, t√†i s·∫£n
2. Workflow r√µ r√†ng: draft ‚Üí confirmed ‚Üí approved ‚Üí posted
3. Theo d√µi ng∆∞·ªùi duy·ªát
4. Ki·ªÉm tra v∆∞·ª£t ng√¢n s√°ch

**‚ö†Ô∏è V·∫§N ƒê·ªÄ:**

| # | V·∫•n ƒê·ªÅ | M·ª©c ƒê·ªô |
|---|--------|--------|
| 1 | `loai_chi` = 'chi_cong_no' nh∆∞ng kh√¥ng b·∫Øt bu·ªôc c√≥ `cong_no_id` | Cao |
| 2 | Kh√¥ng c·∫≠p nh·∫≠t `cong_no_phai_tra` n·∫øu chi tr·∫£ c√¥ng n·ª£ | Cao |
| 3 | `nhan_vien_id` (t·ª´ model nhan_su) ch∆∞a c√≥ trong h·ªá th·ªëng | Cao |
| 4 | Khi chi mua s·∫Øm (`chi_mua_sam`), kh√¥ng t·ª± ƒë·ªông t·∫°o t√†i s·∫£n | Cao |
| 5 | Kh√¥ng ki·ªÉm tra: n·∫øu chi v∆∞·ª£t ng√¢n s√°ch th√¨ kh√¥ng cho ph√©p (ch·ªâ t√≠nh c·∫£nh b√°o) | Trung |
| 6 | Tr∆∞·ªùng `theo_doi_ngan_sach_id` readonly nh∆∞ng kh√¥ng c√≥ logic t·∫°o n√≥ | Cao |

**üî¥ LOGIC THI·∫æU:**
```python
# Khi action_post, c·∫ßn:
‚úÖ C·∫≠p nh·∫≠t cong_no_phai_tra (gi·∫£m s·ªë ti·ªÅn c√≤n n·ª£)
‚ùå C·∫≠p nh·∫≠t theo_doi_thuc_hien (chi th·ª±c t·∫ø)
‚ùå Tr·ª´ t·ª´ ng√¢n s√°ch ph√¢n b·ªï
‚ùå T·∫°o t√†i s·∫£n n·∫øu loai_chi = 'chi_mua_sam'
```

#### 2.4.3 Ph√¢n T√≠ch C√¥ng N·ª£ Ph·∫£i Thu

**‚úÖ T·ªët:**
1. T√≠nh to√°n t·ª± ƒë·ªông: paid_amount, residual
2. C·∫£nh b√°o qu√° h·∫°n
3. Li√™n k·∫øt phi·∫øu thu

**‚ö†Ô∏è V·∫§N ƒê·ªÄ:**
1. Kh√¥ng c√≥ model `cong_no_phai_tra` (ch·ªâ c√≥ ph·∫£i thu)
2. Kh√¥ng c√≥ ki·ªÉm tra: c√¥ng n·ª£ ph·∫£i tr·∫£ khi chi tr·∫£

---

## III. PH√ÇN T√çCH QUAN H·ªÜ GI·ªÆA C√ÅC MODULE

### 3.1 Lu·ªìng D·ªØ Li·ªáu Mong ƒê·ª£i

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ LU·ªíNG NG√ÇN S√ÅCH ƒê·∫¶Y ƒê·ª¶                                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                  ‚îÇ
‚îÇ 1. L·∫≠p Ng√¢n S√°ch (ngan_sach)                                   ‚îÇ
‚îÇ    ‚îú‚îÄ Ph√¢n B·ªï (phan_bo_ngan_sach)                             ‚îÇ
‚îÇ    ‚îî‚îÄ D·ª± To√°n Chi (du_toan_chi) - Duy·ªát                      ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ 2. L·∫≠p Phi·∫øu Chi (phieu_chi)                                   ‚îÇ
‚îÇ    ‚îú‚îÄ Ki·ªÉm Tra Ng√¢n S√°ch (con_lai - amount ‚â• 0?)            ‚îÇ
‚îÇ    ‚îú‚îÄ C·∫≠p Nh·∫≠t D·ª± To√°n (ƒë√£_chi ‚Üë)                            ‚îÇ
‚îÇ    ‚îú‚îÄ C·∫≠p Nh·∫≠t C√¥ng N·ª£ Ph·∫£i Tr·∫£ (con_no ‚Üì) [THI·∫æU!]         ‚îÇ
‚îÇ    ‚îî‚îÄ T·∫°o T√†i S·∫£n (n·∫øu mua s·∫Øm) [THI·∫æU!]                    ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ 3. L·∫≠p Phi·∫øu Thu (phieu_thu)                                   ‚îÇ
‚îÇ    ‚îú‚îÄ C·∫≠p Nh·∫≠t C√¥ng N·ª£ Ph·∫£i Thu (con_no ‚Üì)                  ‚îÇ
‚îÇ    ‚îî‚îÄ C·∫≠p Nh·∫≠t Theo D√µi Ng√¢n S√°ch (thu th·ª±c t·∫ø ‚Üë) [THI·∫æU!]  ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ 4. Thanh L√Ω T√†i S·∫£n (thanh_ly_tai_san)                        ‚îÇ
‚îÇ    ‚îú‚îÄ Phi·∫øu Thu (t·ª± ƒë·ªông t·ª´ thanh_ly)                        ‚îÇ
‚îÇ    ‚îî‚îÄ C·∫≠p Nh·∫≠t T√†i S·∫£n (trang_thai = 'da_thanh_ly')         ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ 5. B√°o C√°o & Theo D√µi                                         ‚îÇ
‚îÇ    ‚îú‚îÄ Theo D√µi Ng√¢n S√°ch (theo_doi_thuc_hien)                ‚îÇ
‚îÇ    ‚îú‚îÄ So S√°nh D·ª± To√°n vs Th·ª±c T·∫ø                             ‚îÇ
‚îÇ    ‚îî‚îÄ C·∫£nh B√°o V∆∞·ª£t Ng√¢n S√°ch                                ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 3.2 C√°c L·ªói Li√™n K·∫øt Ph√°t Hi·ªán

| L·ªói | Module A | Module B | V·∫•n ƒê·ªÅ |
|-----|----------|----------|--------|
| 1 | Phi·∫øu Chi | C√¥ng N·ª£ Ph·∫£i Tr·∫£ | ‚ùå Kh√¥ng c·∫≠p nh·∫≠t con_no khi chi |
| 2 | Phi·∫øu Chi | T√†i S·∫£n | ‚ùå Kh√¥ng t·∫°o t√†i s·∫£n khi mua s·∫Øm |
| 3 | Phi·∫øu Chi | D·ª± To√°n Chi | ‚ùå Kh√¥ng c·∫≠p nh·∫≠t "ƒë√£ chi" trong d·ª± to√°n |
| 4 | Phi·∫øu Thu | Theo D√µi Ng√¢n S√°ch | ‚ùå Kh√¥ng t·∫°o b·∫£n ghi theo d√µi |
| 5 | T√†i S·∫£n | Ng√¢n S√°ch | ‚ùå Kh√¥ng li√™n k·∫øt t√†i s·∫£n v·ªõi phi·∫øu chi/d·ª± to√°n mua |
| 6 | VƒÉn B·∫£n | T·∫•t c·∫£ | ‚ùå Ho√†n to√†n kh√¥ng li√™n k·∫øt |

---

## IV. PH√ÅT HI·ªÜN L·ªñI LOGIC & KH√îNG NH·∫§T QU√ÅN

### 4.1 Tr·∫°ng Th√°i (Status) Kh√¥ng Nh·∫•t Qu√°n

**V·∫•n ƒê·ªÅ:** C√°c module d√πng t√™n tr·∫°ng th√°i kh√°c nhau

```python
# ngan_sach
state = ['nhap', 'duyet', 'dang_thuc_hien', 'ket_thuc', 'huy']

# phieu_chi
state = ['draft', 'confirmed', 'approved', 'posted', 'cancel']

# cong_no_phai_thu
state = ['draft', 'open', 'partial', 'paid', 'cancel']

# tai_san
trang_thai_thanh_ly = ['chua_phan_bo', 'da_phan_bo', 'chua_thanh_ly', 'da_thanh_ly']
```

**ƒê·ªÅ Xu·∫•t:** Th·ªëng nh·∫•t convention:
```python
# Ti√™u chu·∫©n cho t·∫•t c·∫£
state = [
    ('draft', 'Nh√°p'),           # M·ªõi t·∫°o
    ('confirmed', 'ƒê√£ x√°c nh·∫≠n'), # X√°c nh·∫≠n
    ('approved', 'ƒê√£ duy·ªát'),    # Qu·∫£n l√Ω duy·ªát
    ('posted', 'ƒê√£ ghi s·ªï'),     # K·∫ø to√°n ghi s·ªï
    ('cancelled', 'ƒê√£ h·ªßy'),     # H·ªßy
]
```

### 4.2 Thi·∫øu R√†ng Bu·ªôc D·ªØ Li·ªáu Quan Tr·ªçng

```python
# ‚ùå L·ªñI 1: phan_bo_ngan_sach kh√¥ng ki·ªÉm tra t·ªïng kh√¥ng v∆∞·ª£t qu√° ngan_sach.tong_ngan_sach
@api.constrains('so_tien')
def _check_tong_phan_bo(self):
    # ‚ùå KH√îNG C√ì logic n√†y!
    pass

# ‚úÖ PH·∫¢I S·ª¨A:
@api.constrains('so_tien')
def _check_phan_bo_not_exceed_budget(self):
    for record in self:
        total = record.ngan_sach_id.tong_phan_bo
        if total > record.ngan_sach_id.tong_ngan_sach:
            raise ValidationError(
                f'T·ªïng ph√¢n b·ªï ({total}) v∆∞·ª£t qu√° ng√¢n s√°ch ({record.ngan_sach_id.tong_ngan_sach})'
            )
```

### 4.3 Thi·∫øu "ƒê√£ Chi Th·ª±c T·∫ø"

Trong d·ª± to√°n chi:
```python
# Hi·ªán t·∫°i ch·ªâ c√≥:
so_tien_du_kien = 100,000    # D·ª± ki·∫øn chi
so_tien_duyet = 80,000        # ƒê∆∞·ª£c duy·ªát chi

# ‚ùå THI·∫æU:
# da_chi_thuc_te = ?           # ƒê√£ chi bao nhi√™u? (li√™n k·∫øt t·ª´ phieu_chi)
# con_lai = so_tien_duyet - da_chi_thuc_te  # C√≤n l·∫°i bao nhi√™u?
```

**H·∫≠u qu·∫£:** Kh√¥ng bi·∫øt d·ª± to√°n chi ƒë√£ th·ª±c hi·ªán bao nhi√™u %.

---

## V. ƒê·ªÄ XU·∫§T GI·∫¢I PH√ÅP

### 5.1 ∆Øu Ti√™n Cao (PH·∫¢I S·ª¨A NGAY)

#### 5.1.1 Th√™m Model: `cong_no_phai_tra`

```python
class CongNoPhaiTra(models.Model):
    _name = 'cong_no_phai_tra'
    _description = 'C√¥ng n·ª£ ph·∫£i tr·∫£ (nh√¢n vi√™n, nh√† cung c·∫•p, v.v)'
    
    name = fields.Char('M√£', default='New')
    partner_id = fields.Many2one('res.partner', required=True)
    
    amount = fields.Monetary('S·ªë ti·ªÅn g·ªëc', required=True)
    paid_amount = fields.Monetary('ƒê√£ tr·∫£', compute='_compute_paid')
    residual = fields.Monetary('C√≤n n·ª£', compute='_compute_residual')
    
    state = fields.Selection([
        ('draft', 'Nh√°p'),
        ('open', 'ƒêang n·ª£'),
        ('partial', 'Tr·∫£ m·ªôt ph·∫ßn'),
        ('paid', 'ƒê√£ tr·∫£ ƒë·ªß'),
        ('cancelled', 'H·ªßy'),
    ], default='draft')
    
    # Li√™n k·∫øt v·ªõi phi·∫øu chi
    phieu_chi_ids = fields.One2many('phieu_chi', 'cong_no_phai_tra_id')
```

#### 5.1.2 C·∫≠p Nh·∫≠t `phieu_chi` Khi Ghi S·ªï

```python
def action_post(self):
    """Ghi s·ªï phi·∫øu chi"""
    for rec in self:
        # ‚úÖ TH√äM: C·∫≠p nh·∫≠t c√¥ng n·ª£ ph·∫£i tr·∫£
        if rec.loai_chi == 'chi_cong_no' and rec.cong_no_phai_tra_id:
            rec.cong_no_phai_tra_id._update_payment(rec.amount, rec.id)
        
        # ‚úÖ TH√äM: C·∫≠p nh·∫≠t d·ª± to√°n chi
        if rec.du_toan_chi_id:
            rec.du_toan_chi_id.write({
                'da_chi_thuc_te': rec.du_toan_chi_id.da_chi_thuc_te + rec.amount
            })
        
        # ‚úÖ TH√äM: T·∫°o t√†i s·∫£n n·∫øu mua s·∫Øm
        if rec.loai_chi == 'chi_mua_sam':
            self._create_tai_san_from_purchase(rec)
```

#### 5.1.3 Th√™m "ƒê√£ Chi" trong D·ª± To√°n Chi

```python
# Trong du_toan_chi.py
da_chi_thuc_te = fields.Monetary('ƒê√£ chi th·ª±c t·∫ø', default=0)
con_lai_chi = fields.Monetary('C√≤n l·∫°i chi', compute='_compute_con_lai_chi')

@api.depends('so_tien_duyet', 'da_chi_thuc_te')
def _compute_con_lai_chi(self):
    for rec in self:
        rec.con_lai_chi = rec.so_tien_duyet - rec.da_chi_thuc_te
```

### 5.2 ∆Øu Ti√™n Trung (N√äN S·ª¨A)

#### 5.2.1 Ho√†n Thi·ªán Module VƒÉn B·∫£n

```python
# quan_ly_van_ban/models/van_ban_di.py

class VanBanDi(models.Model):
    _name = 'van_ban_di'
    _description = 'VƒÉn b·∫£n ƒëi'
    _inherit = ['mail.thread', 'mail.activity.mixin']
    _order = 'ngay_ban_hanh desc'
    
    ma_van_ban = fields.Char('M√£', required=True, unique=True)
    ten_van_ban = fields.Char('T√™n', required=True)
    
    # Th√™m c√°c tr∆∞·ªùng thi·∫øu
    loai_van_ban = fields.Selection([
        ('thong_bao', 'Th√¥ng b√°o'),
        ('quyet_dinh', 'Quy·∫øt ƒë·ªãnh'),
        ('hop_dong', 'H·ª£p ƒë·ªìng'),
        ('thoathuan', 'Th·ªèa thu·∫≠n'),
        ('chi_thi', 'Ch·ªâ th·ªã'),
        ('khac', 'Kh√°c'),
    ], required=True)
    
    noi_dung = fields.Html('N·ªôi dung')
    file_dinh_kem = fields.Binary('File', attachment=True)
    
    ngay_ban_hanh = fields.Date('Ng√†y ban h√†nh', required=True)
    ngay_hieu_luc = fields.Date('Ng√†y hi·ªáu l·ª±c')
    
    nguoi_ky = fields.Many2one('res.users', 'Ng∆∞·ªùi k√Ω')
    phong_ban_id = fields.Many2one('phong_ban', 'Ph√≤ng ban ph√°t h√†nh')
    
    state = fields.Selection([
        ('draft', 'Nh√°p'),
        ('issued', 'ƒê√£ ban h√†nh'),
        ('cancelled', 'ƒê√£ h·ªßy'),
    ], default='draft')
    
    # Li√™n k·∫øt v·ªõi ng√¢n s√°ch, t√†i s·∫£n n·∫øu c·∫ßn
    ngan_sach_id = fields.Many2one('ngan_sach', 'Ng√¢n s√°ch li√™n quan')
    tai_san_ids = fields.Many2many('tai_san', 'T√†i s·∫£n li√™n quan')
```

#### 5.2.2 Th·ªëng Nh·∫•t T√™n Tr·∫°ng Th√°i

Thay t·∫•t c·∫£ `trang_thai` ‚Üí `state` v√† d√πng convention duy nh·∫•t.

### 5.3 ∆Øu Ti√™n Th·∫•p (C√ì TH·ªÇ ƒê·ª¢)

1. T·ªëi ∆∞u h√≥a b√°o c√°o (dashboard)
2. Th√™m l·ªãch s·ª≠ thay ƒë·ªïi tr·∫°ng th√°i (audit log)
3. Th√™m ph√™ duy·ªát nhi·ªÅu c·∫•p

---

## VI. DANH S√ÅCH ISSUES & FIXES

### Issue #1: Kh√¥ng C·∫≠p Nh·∫≠t C√¥ng N·ª£ Khi Chi

**File:** `quanly_thuchi_congno/models/phieu_chi.py`

**D√≤ng:** action_post()

**S·ª≠a:**
```python
def action_post(self):
    for rec in self:
        # ... code c≈© ...
        
        # TH√äM: C·∫≠p nh·∫≠t c√¥ng n·ª£ ph·∫£i tr·∫£
        if rec.loai_chi == 'chi_cong_no' and rec.cong_no_phai_tra_id:
            cong_no = rec.cong_no_phai_tra_id
            cong_no._update_payment(rec.amount, rec.name)
            
            # C·∫≠p nh·∫≠t tr·∫°ng th√°i c√¥ng n·ª£
            if cong_no.residual <= 0:
                cong_no.state = 'paid'
            elif cong_no.residual < cong_no.amount:
                cong_no.state = 'partial'
```

---

## VII. T√ìMM·ª®C Y·∫æU T·ªê CH√çNH C·∫¶N C·∫¢I THI·ªÜN

| Y·∫øu T·ªë | Tr·∫°ng Th√°i | M·ª©c ƒê·ªô Nghi√™m Tr·ªçng |
|--------|-----------|-------------------|
| Li√™n k·∫øt Phi·∫øu Chi ‚Üî C√¥ng N·ª£ Ph·∫£i Tr·∫£ | ‚ùå Ch∆∞a c√≥ | üî¥ Cao |
| Li√™n k·∫øt Phi·∫øu Chi ‚Üî T·∫°o T√†i S·∫£n | ‚ùå Ch∆∞a c√≥ | üî¥ Cao |
| Li√™n k·∫øt D·ª± To√°n ‚Üî Th·ª±c T·∫ø Chi | ‚ùå Ch∆∞a c√≥ | üî¥ Cao |
| Ki·ªÉm Tra T·ªïng Ph√¢n B·ªï ‚â§ Ng√¢n S√°ch | ‚ùå Ch∆∞a c√≥ | üü† Trung |
| Module VƒÉn B·∫£n Qu√° ƒê∆°n Gi·∫£n | ‚ö†Ô∏è C∆° B·∫£n | üü† Trung |
| Th·ªëng Nh·∫•t T√™n Tr·∫°ng Th√°i | ‚ùå Ch∆∞a c√≥ | üü° Th·∫•p |

---

## VIII. KHUY·∫æN NGH·ªä V·ªÄ QUI TR√åNH

### Chu K·ª≥ Sinh D·ªØ Li·ªáu - Y√äU C·∫¶U TH·ª∞C HI·ªÜN ƒê·∫¶Y ƒê·ª¶

```
[1] L·∫≠p Ng√¢n S√°ch
    ‚Üì
[2] Ph√¢n B·ªï Ng√¢n S√°ch & D·ª± To√°n Chi ‚Üí Duy·ªát
    ‚Üì
[3] L·∫≠p Phi·∫øu Chi
    ‚îú‚îÄ‚Üí KI·ªÇM TRA: c√≤n_lai_chi - amount ‚â• 0?
    ‚îú‚îÄ‚Üí KI·ªÇM TRA: con_lai_ngan_sach - amount ‚â• 0?
    ‚îú‚îÄ‚Üí N·∫øu mua s·∫Øm: T·∫°o b·∫£n ghi T√†i S·∫£n
    ‚îî‚îÄ‚Üí X√°c Nh·∫≠n ‚Üí Duy·ªát ‚Üí Ghi S·ªï
        ‚îî‚îÄ‚Üí C·∫¨P NH·∫¨T: du_toan_chi.da_chi_thuc_te ‚Üë
        ‚îî‚îÄ‚Üí C·∫¨P NH·∫¨T: cong_no_phai_tra.residual ‚Üì
        ‚îî‚îÄ‚Üí C·∫¨P NH·∫¨T: theo_doi_thuc_hien_ngan_sach
    ‚Üì
[4] L·∫≠p Phi·∫øu Thu (t·ª´ C√¥ng N·ª£ Ph·∫£i Thu ho·∫∑c Thanh L√Ω)
    ‚îú‚îÄ‚Üí X√°c Nh·∫≠n ‚Üí Ghi S·ªï
    ‚îî‚îÄ‚Üí C·∫¨P NH·∫¨T: cong_no_phai_thu.residual ‚Üì
    ‚îî‚îÄ‚Üí C·∫¨P NH·∫¨T: theo_doi_thuc_hien_ngan_sach
    ‚Üì
[5] B√°o C√°o
    ‚îú‚îÄ So s√°nh D·ª± To√°n vs Th·ª±c T·∫ø
    ‚îú‚îÄ C·∫£nh b√°o V∆∞·ª£t Ng√¢n S√°ch
    ‚îú‚îÄ C√¥ng N·ª£ Qu√° H·∫°n
    ‚îî‚îÄ T√¨nh Tr·∫°ng T√†i S·∫£n
```

---

**K·∫æT TH√öC B√ÅO C√ÅO**
