# BÃO CÃO PHÃ‚N TÃCH NGHIá»†P Vá»¤ - Há»† THá»NG QUáº¢N LÃ TÃ€I CHÃNH HÃ€ HÃ€NH CHÃNH

**NgÃ y phÃ¢n tÃ­ch:** 21/01/2026  
**PhiÃªn báº£n:** 1.0  
**PhÃ¢n tÃ­ch bá»Ÿi:** Business Analyst & Software Engineer  

---

## I. Tá»”NG QUAN Há»† THá»NG

### 1.1 CÃ¡c Module ChÃ­nh
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Há»† THá»NG QUáº¢N LÃ TÃ€I CHÃNH & HÃ€NH CHÃNH                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Quáº£n LÃ½ NgÃ¢n SÃ¡ch â”‚  â”‚Quáº£n LÃ½ TÃ i Sáº£n   â”‚  â”‚Quáº£n LÃ½ VÄƒn Báº£nâ”‚ â”‚
â”‚  â”‚ (quan_ly_ngan_sach)â”‚ (quan_ly_tai_san) â”‚  â”‚(quan_ly_van_ban)â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â–²                      â–²                   â–²            â”‚
â”‚           â”‚                      â”‚                   â”‚            â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                  â”‚                                â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚                   â–¼                             â–¼                â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚           â”‚ Thu Chi & CÃ´ng Ná»£â”‚        â”‚  NhÃ¢n Sá»±         â”‚      â”‚
â”‚           â”‚(quanly_thuchi_   â”‚        â”‚  (nhan_su)       â”‚      â”‚
â”‚           â”‚ congno)          â”‚        â”‚  [External]      â”‚      â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 MÃ´ táº£ TÃ³m Táº¯t

| Module | Chá»©c NÄƒng ChÃ­nh | Tráº¡ng ThÃ¡i Code |
|--------|-----------------|-----------------|
| **Quáº£n LÃ½ NgÃ¢n SÃ¡ch** | Láº­p KH ngÃ¢n sÃ¡ch, phÃ¢n bá»•, theo dÃµi thá»±c hiá»‡n | âœ… Cáº¥u trÃºc tá»‘t |
| **Quáº£n LÃ½ TÃ i Sáº£n** | Quáº£n lÃ½ tÃ i sáº£n, kháº¥u hao, luÃ¢n chuyá»ƒn, thanh lÃ½ | âœ… Chi tiáº¿t |
| **Quáº£n LÃ½ VÄƒn Báº£n** | Quáº£n lÃ½ vÄƒn báº£n Ä‘i/Ä‘áº¿n | âš ï¸ QuÃ¡ Ä‘Æ¡n giáº£n |
| **Thu Chi & CÃ´ng Ná»£** | Phiáº¿u thu/chi, theo dÃµi cÃ´ng ná»£ | âœ… TÆ°Æ¡ng Ä‘á»‘i Ä‘áº§y Ä‘á»§ |

---

## II. PHÃ‚N TÃCH CHI TIáº¾T Tá»ªNG MODULE

### 2.1 MODULE: QUáº¢N LÃ NGÃ‚N SÃCH (quan_ly_ngan_sach)

#### 2.1.1 Cáº¥u TrÃºc Models
```
ngan_sach (NgÃ¢n SÃ¡ch)
â”œâ”€â”€ du_toan_chi (Dá»± ToÃ¡n Chi)
â”œâ”€â”€ phan_bo_ngan_sach (PhÃ¢n Bá»• NgÃ¢n SÃ¡ch)
â””â”€â”€ theo_doi_thuc_hien_ngan_sach (Theo DÃµi Thá»±c Hiá»‡n)
```

#### 2.1.2 PhÃ¢n TÃ­ch Logic ChÃ­nh

**âœ… Äiá»ƒm Tá»‘t:**
1. PhÃ¢n loáº¡i ngÃ¢n sÃ¡ch rÃµ rÃ ng (nÄƒm, quÃ½, thÃ¡ng, dá»± Ã¡n)
2. CÃ³ rÃ ng buá»™c dá»¯ liá»‡u (unique ma_ngan_sach, kiá»ƒm tra ngÃ y)
3. Theo dÃµi ngÆ°á»i láº­p, ngÆ°á»i duyá»‡t
4. TÃ­nh toÃ¡n tá»± Ä‘á»™ng: tá»•ng phÃ¢n bá»•, cÃ²n láº¡i

**âš ï¸ Váº¤N Äá»€ PHÃT HIá»†N:**

| # | Váº¥n Äá» | Má»©c Äá»™ | áº¢nh HÆ°á»Ÿng |
|---|--------|--------|----------|
| 1 | KhÃ´ng cÃ³ trÆ°á»ng `description` Ä‘á»ƒ giáº£i thÃ­ch ngÃ¢n sÃ¡ch | Tháº¥p | Dá»… hiá»ƒu sai |
| 2 | KhÃ´ng cÃ³ sá»‘ tiá»n chi tiáº¿t theo dá»± toÃ¡n trong ngÃ¢n sÃ¡ch | Cao | KhÃ´ng theo dÃµi Ä‘Æ°á»£c chi tiÃªu thá»±c táº¿ so vá»›i káº¿ hoáº¡ch |
| 3 | Thiáº¿u phÃ©p tÃ­nh: "ÄÃ£ chi thá»±c táº¿" vs "Dá»± toÃ¡n chi Ä‘Æ°á»£c duyá»‡t" | Cao | KhÃ´ng biáº¿t vÆ°á»£t hay tiáº¿t kiá»‡m Ä‘Æ°á»£c bao nhiÃªu |
| 4 | TrÆ°á»ng `quy`, `thang` khÃ´ng báº¯t buá»™c khi loáº¡i_ngan_sach = 'quy'/'thang' | Cao | Dá»¯ liá»‡u khÃ´ng nháº¥t quÃ¡n |
| 5 | KhÃ´ng cÃ³ kiá»ƒm tra: tá»•ng phan_bo khÃ´ng Ä‘Æ°á»£c vÆ°á»£t tong_ngan_sach | Cao | CÃ³ thá»ƒ phÃ¢n bá»• quÃ¡ má»©c |
| 6 | KhÃ´ng lÆ°u lá»‹ch sá»­ thay Ä‘á»•i tráº¡ng thÃ¡i (khi nÃ o duyá»‡t, há»§y) | Trung | KhÃ³ audit |
| 7 | KhÃ´ng cÃ³ liÃªn káº¿t trá»±c tiáº¿p tá»›i phiáº¿u chi Ä‘á»ƒ kiá»ƒm tra vÆ°á»£t ngÃ¢n sÃ¡ch | Cao | KhÃ´ng cáº£nh bÃ¡o khi chi vÆ°á»£t |

**ğŸ”´ LOGIC Lá»–I TRONG Dá»° TOÃN CHI:**
- Dá»± toÃ¡n chi cÃ³ 2 trÆ°á»ng tiá»n: `so_tien_du_kien` vs `so_tien_duyet`
- NhÆ°ng **khÃ´ng cÃ³ trÆ°á»ng lÆ°u "Ä‘Ã£ chi thá»±c táº¿"** â†’ khÃ´ng biáº¿t tÃ¬nh tráº¡ng thá»±c hiá»‡n
- Tráº¡ng thÃ¡i = 'hoan_thanh' nhÆ°ng khÃ´ng kiá»ƒm tra Ä‘Ã£ chi háº¿t chÆ°a

---

### 2.2 MODULE: QUáº¢N LÃ TÃ€I Sáº¢N (quan_ly_tai_san)

#### 2.2.1 Cáº¥u TrÃºc Models
```
tai_san (TÃ i Sáº£n)
â”œâ”€â”€ danh_muc_tai_san (Danh Má»¥c)
â”œâ”€â”€ phan_bo_tai_san (PhÃ¢n Bá»•)
â”œâ”€â”€ lich_su_khau_hao (Lá»‹ch Sá»­ Kháº¥u Hao)
â”œâ”€â”€ kich_ke_tai_san (Kiá»ƒm KÃª)
â”œâ”€â”€ luan_chuyen_tai_san (LuÃ¢n Chuyá»ƒn)
â”œâ”€â”€ thanh_ly_tai_san (Thanh LÃ½)
â””â”€â”€ lich_su_ky_thuat (Lá»‹ch Sá»­ Ká»¹ Thuáº­t)
```

#### 2.2.2 PhÃ¢n TÃ­ch

**âœ… Äiá»ƒm Tá»‘t:**
1. Chi tiáº¿t tÃ i sáº£n: giÃ¡ trá»‹, kháº¥u hao, lá»‹ch sá»­ sá»­ dá»¥ng
2. Theo dÃµi nhiá»u khÃ­a cáº¡nh: ká»¹ thuáº­t, kháº¥u hao, kiá»ƒm kÃª, luÃ¢n chuyá»ƒn
3. HÃ¬nh áº£nh & giáº¥y tá» liÃªn quan
4. TÃ­nh tráº¡ng thÃ¡i tá»± Ä‘á»™ng (chua_phan_bo, da_phan_bo, da_thanh_ly)

**âš ï¸ Váº¤N Äá»€:**

| # | Váº¥n Äá» | Má»©c Äá»™ | 
|---|--------|--------|
| 1 | **THIáº¾U LIÃŠN Káº¾T NGÃ‚N SÃCH:** KhÃ´ng lÆ°u tÃ i sáº£n Ä‘Æ°á»£c mua tá»« dá»± toÃ¡n/phiáº¿u chi nÃ o | Cao |
| 2 | **THIáº¾U LIÃŠN Káº¾T THU CHI:** KhÃ´ng liÃªn káº¿t phiáº¿u chi (mua) vÃ  phiáº¿u thu (thanh lÃ½) | Cao |
| 3 | Kháº¥u hao tÃ­nh sai: `gia_tri_hien_tai` nháº­p thá»§ cÃ´ng, khÃ´ng tÃ­nh tá»± Ä‘á»™ng theo cÃ´ng thá»©c | Cao |
| 4 | KhÃ´ng cÃ³ trÆ°á»ng theo dÃµi "tÃ¬nh tráº¡ng" (hoáº¡t Ä‘á»™ng, báº£o dÆ°á»¡ng, há»ng, thanh lÃ½) | Trung |
| 5 | KhÃ´ng kiá»ƒm tra: giÃ¡ trá»‹ hiá»‡n táº¡i â‰¥ 0 | Trung |
| 6 | `don_vi_tinh` lÃ  Char, khÃ´ng liÃªn káº¿t tá»›i báº£ng danh má»¥c | Tháº¥p |

**ğŸ”´ BUG LOGIC:**
```python
# DÃ²ng 55-60: TÃ­nh tráº¡ng thÃ¡i nhÆ°ng logic sai
@api.depends('thanh_ly_ids', 'phong_ban_su_dung_ids')
def _compute_trang_thai_thanh_ly(self):
    # Náº¿u thanh_ly_ids > 0 â†’ 'da_thanh_ly' âœ…
    # Elif phong_ban_su_dung_ids > 0 â†’ 'da_phan_bo' âœ…
    # Else â†’ 'chua_phan_bo' âŒ (nhÆ°ng tÃ i sáº£n má»›i vÃ o kho cÅ©ng cÃ³ tráº¡ng thÃ¡i nÃ y)
```

---

### 2.3 MODULE: QUáº¢N LÃ VÄ‚N Báº¢N (quan_ly_van_ban)

#### 2.3.1 PhÃ¢n TÃ­ch

**ğŸ”´ Váº¤N Äá»€ NGHIÃŠM TRá»ŒNG:**

VÄƒn báº£n Ä‘i hiá»‡n táº¡i chá»‰ cÃ³ 1 trÆ°á»ng: `ten_van_ban`

**Thiáº¿u cÃ¡c trÆ°á»ng quan trá»ng:**
- MÃ£ vÄƒn báº£n (unique)
- NgÃ y ban hÃ nh / NgÃ y hiá»‡u lá»±c
- NgÆ°á»i kÃ½ / NgÆ°á»i phÃª duyá»‡t
- PhÃ²ng ban liÃªn quan / Äá»‘i tÃ¡c liÃªn quan
- Tráº¡ng thÃ¡i (NhÃ¡p, Ban hÃ nh, Há»§y)
- Ná»™i dung / File Ä‘Ã­nh kÃ¨m
- PhÃ¢n loáº¡i vÄƒn báº£n (ThÃ´ng bÃ¡o, Quyáº¿t Ä‘á»‹nh, Há»£p Ä‘á»“ng, v.v)

**Thiáº¿u liÃªn káº¿t:**
- âŒ KhÃ´ng liÃªn káº¿t vá»›i phÃ²ng ban / nhÃ¢n viÃªn
- âŒ KhÃ´ng liÃªn káº¿t vá»›i dá»± Ã¡n / hoáº¡t Ä‘á»™ng
- âŒ KhÃ´ng liÃªn káº¿t vá»›i ngÃ¢n sÃ¡ch / tÃ i sáº£n khi lÃ  quyáº¿t Ä‘á»‹nh phÃª duyá»‡t

---

### 2.4 MODULE: QUáº¢N LÃ THU CHI & CÃ”NG Ná»¢ (quanly_thuchi_congno)

#### 2.4.1 Cáº¥u TrÃºc
```
phieu_thu (Phiáº¿u Thu)
phieu_chi (Phiáº¿u Chi)
â”œâ”€â”€ cong_no_phai_thu (CÃ´ng Ná»£ Pháº£i Thu)
â””â”€â”€ cong_no_phai_tra (CÃ´ng Ná»£ Pháº£i Tráº£) [ChÆ°a tháº¥y model nÃ y]
```

#### 2.4.2 PhÃ¢n TÃ­ch Phiáº¿u Chi

**âœ… Äiá»ƒm Tá»‘t:**
1. LiÃªn káº¿t cÃ´ng ná»£, ngÃ¢n sÃ¡ch, tÃ i sáº£n
2. Workflow rÃµ rÃ ng: draft â†’ confirmed â†’ approved â†’ posted
3. Theo dÃµi ngÆ°á»i duyá»‡t
4. Kiá»ƒm tra vÆ°á»£t ngÃ¢n sÃ¡ch

**âš ï¸ Váº¤N Äá»€:**

| # | Váº¥n Äá» | Má»©c Äá»™ |
|---|--------|--------|
| 1 | `loai_chi` = 'chi_cong_no' nhÆ°ng khÃ´ng báº¯t buá»™c cÃ³ `cong_no_id` | Cao |
| 2 | KhÃ´ng cáº­p nháº­t `cong_no_phai_tra` náº¿u chi tráº£ cÃ´ng ná»£ | Cao |
| 3 | `nhan_vien_id` (tá»« model nhan_su) chÆ°a cÃ³ trong há»‡ thá»‘ng | Cao |
| 4 | Khi chi mua sáº¯m (`chi_mua_sam`), khÃ´ng tá»± Ä‘á»™ng táº¡o tÃ i sáº£n | Cao |
| 5 | KhÃ´ng kiá»ƒm tra: náº¿u chi vÆ°á»£t ngÃ¢n sÃ¡ch thÃ¬ khÃ´ng cho phÃ©p (chá»‰ tÃ­nh cáº£nh bÃ¡o) | Trung |
| 6 | TrÆ°á»ng `theo_doi_ngan_sach_id` readonly nhÆ°ng khÃ´ng cÃ³ logic táº¡o nÃ³ | Cao |

**ğŸ”´ LOGIC THIáº¾U:**
```python
# Khi action_post, cáº§n:
âœ… Cáº­p nháº­t cong_no_phai_tra (giáº£m sá»‘ tiá»n cÃ²n ná»£)
âŒ Cáº­p nháº­t theo_doi_thuc_hien (chi thá»±c táº¿)
âŒ Trá»« tá»« ngÃ¢n sÃ¡ch phÃ¢n bá»•
âŒ Táº¡o tÃ i sáº£n náº¿u loai_chi = 'chi_mua_sam'
```

#### 2.4.3 PhÃ¢n TÃ­ch CÃ´ng Ná»£ Pháº£i Thu

**âœ… Tá»‘t:**
1. TÃ­nh toÃ¡n tá»± Ä‘á»™ng: paid_amount, residual
2. Cáº£nh bÃ¡o quÃ¡ háº¡n
3. LiÃªn káº¿t phiáº¿u thu

**âš ï¸ Váº¤N Äá»€:**
1. KhÃ´ng cÃ³ model `cong_no_phai_tra` (chá»‰ cÃ³ pháº£i thu)
2. KhÃ´ng cÃ³ kiá»ƒm tra: cÃ´ng ná»£ pháº£i tráº£ khi chi tráº£

---

## III. PHÃ‚N TÃCH QUAN Há»† GIá»®A CÃC MODULE

### 3.1 Luá»“ng Dá»¯ Liá»‡u Mong Äá»£i

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LUá»’NG NGÃ‚N SÃCH Äáº¦Y Äá»¦                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚ 1. Láº­p NgÃ¢n SÃ¡ch (ngan_sach)                                   â”‚
â”‚    â”œâ”€ PhÃ¢n Bá»• (phan_bo_ngan_sach)                             â”‚
â”‚    â””â”€ Dá»± ToÃ¡n Chi (du_toan_chi) - Duyá»‡t                      â”‚
â”‚                                                                  â”‚
â”‚ 2. Láº­p Phiáº¿u Chi (phieu_chi)                                   â”‚
â”‚    â”œâ”€ Kiá»ƒm Tra NgÃ¢n SÃ¡ch (con_lai - amount â‰¥ 0?)            â”‚
â”‚    â”œâ”€ Cáº­p Nháº­t Dá»± ToÃ¡n (Ä‘Ã£_chi â†‘)                            â”‚
â”‚    â”œâ”€ Cáº­p Nháº­t CÃ´ng Ná»£ Pháº£i Tráº£ (con_no â†“) [THIáº¾U!]         â”‚
â”‚    â””â”€ Táº¡o TÃ i Sáº£n (náº¿u mua sáº¯m) [THIáº¾U!]                    â”‚
â”‚                                                                  â”‚
â”‚ 3. Láº­p Phiáº¿u Thu (phieu_thu)                                   â”‚
â”‚    â”œâ”€ Cáº­p Nháº­t CÃ´ng Ná»£ Pháº£i Thu (con_no â†“)                  â”‚
â”‚    â””â”€ Cáº­p Nháº­t Theo DÃµi NgÃ¢n SÃ¡ch (thu thá»±c táº¿ â†‘) [THIáº¾U!]  â”‚
â”‚                                                                  â”‚
â”‚ 4. Thanh LÃ½ TÃ i Sáº£n (thanh_ly_tai_san)                        â”‚
â”‚    â”œâ”€ Phiáº¿u Thu (tá»± Ä‘á»™ng tá»« thanh_ly)                        â”‚
â”‚    â””â”€ Cáº­p Nháº­t TÃ i Sáº£n (trang_thai = 'da_thanh_ly')         â”‚
â”‚                                                                  â”‚
â”‚ 5. BÃ¡o CÃ¡o & Theo DÃµi                                         â”‚
â”‚    â”œâ”€ Theo DÃµi NgÃ¢n SÃ¡ch (theo_doi_thuc_hien)                â”‚
â”‚    â”œâ”€ So SÃ¡nh Dá»± ToÃ¡n vs Thá»±c Táº¿                             â”‚
â”‚    â””â”€ Cáº£nh BÃ¡o VÆ°á»£t NgÃ¢n SÃ¡ch                                â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 CÃ¡c Lá»—i LiÃªn Káº¿t PhÃ¡t Hiá»‡n

| Lá»—i | Module A | Module B | Váº¥n Äá» |
|-----|----------|----------|--------|
| 1 | Phiáº¿u Chi | CÃ´ng Ná»£ Pháº£i Tráº£ | âŒ KhÃ´ng cáº­p nháº­t con_no khi chi |
| 2 | Phiáº¿u Chi | TÃ i Sáº£n | âŒ KhÃ´ng táº¡o tÃ i sáº£n khi mua sáº¯m |
| 3 | Phiáº¿u Chi | Dá»± ToÃ¡n Chi | âŒ KhÃ´ng cáº­p nháº­t "Ä‘Ã£ chi" trong dá»± toÃ¡n |
| 4 | Phiáº¿u Thu | Theo DÃµi NgÃ¢n SÃ¡ch | âŒ KhÃ´ng táº¡o báº£n ghi theo dÃµi |
| 5 | TÃ i Sáº£n | NgÃ¢n SÃ¡ch | âŒ KhÃ´ng liÃªn káº¿t tÃ i sáº£n vá»›i phiáº¿u chi/dá»± toÃ¡n mua |
| 6 | VÄƒn Báº£n | Táº¥t cáº£ | âŒ HoÃ n toÃ n khÃ´ng liÃªn káº¿t |

---

## IV. PHÃT HIá»†N Lá»–I LOGIC & KHÃ”NG NHáº¤T QUÃN

### 4.1 Tráº¡ng ThÃ¡i (Status) KhÃ´ng Nháº¥t QuÃ¡n

**Váº¥n Äá»:** CÃ¡c module dÃ¹ng tÃªn tráº¡ng thÃ¡i khÃ¡c nhau

```python
# ngan_sach
state = ['nhap', 'duyet', 'dang_thuc_hien', 'ket_thuc', 'huy']

# phieu_chi
state = ['draft', 'confirmed', 'approved', 'posted', 'cancel']

# cong_no_phai_thu
state = ['draft', 'open', 'partial', 'paid', 'cancel']

# tai_san
trang_thai_thanh_ly = ['chua_phan_bo', 'da_phan_bo', 'chua_thanh_ly', 'da_thanh_ly']
```

**Äá» Xuáº¥t:** Thá»‘ng nháº¥t convention:
```python
# TiÃªu chuáº©n cho táº¥t cáº£
state = [
    ('draft', 'NhÃ¡p'),           # Má»›i táº¡o
    ('confirmed', 'ÄÃ£ xÃ¡c nháº­n'), # XÃ¡c nháº­n
    ('approved', 'ÄÃ£ duyá»‡t'),    # Quáº£n lÃ½ duyá»‡t
    ('posted', 'ÄÃ£ ghi sá»•'),     # Káº¿ toÃ¡n ghi sá»•
    ('cancelled', 'ÄÃ£ há»§y'),     # Há»§y
]
```

### 4.2 Thiáº¿u RÃ ng Buá»™c Dá»¯ Liá»‡u Quan Trá»ng

```python
# âŒ Lá»–I 1: phan_bo_ngan_sach khÃ´ng kiá»ƒm tra tá»•ng khÃ´ng vÆ°á»£t quÃ¡ ngan_sach.tong_ngan_sach
@api.constrains('so_tien')
def _check_tong_phan_bo(self):
    # âŒ KHÃ”NG CÃ“ logic nÃ y!
    pass

# âœ… PHáº¢I Sá»¬A:
@api.constrains('so_tien')
def _check_phan_bo_not_exceed_budget(self):
    for record in self:
        total = record.ngan_sach_id.tong_phan_bo
        if total > record.ngan_sach_id.tong_ngan_sach:
            raise ValidationError(
                f'Tá»•ng phÃ¢n bá»• ({total}) vÆ°á»£t quÃ¡ ngÃ¢n sÃ¡ch ({record.ngan_sach_id.tong_ngan_sach})'
            )
```

### 4.3 Thiáº¿u "ÄÃ£ Chi Thá»±c Táº¿"

Trong dá»± toÃ¡n chi:
```python
# Hiá»‡n táº¡i chá»‰ cÃ³:
so_tien_du_kien = 100,000    # Dá»± kiáº¿n chi
so_tien_duyet = 80,000        # ÄÆ°á»£c duyá»‡t chi

# âŒ THIáº¾U:
# da_chi_thuc_te = ?           # ÄÃ£ chi bao nhiÃªu? (liÃªn káº¿t tá»« phieu_chi)
# con_lai = so_tien_duyet - da_chi_thuc_te  # CÃ²n láº¡i bao nhiÃªu?
```

**Háº­u quáº£:** KhÃ´ng biáº¿t dá»± toÃ¡n chi Ä‘Ã£ thá»±c hiá»‡n bao nhiÃªu %.

---

## V. Äá»€ XUáº¤T GIáº¢I PHÃP

### 5.1 Æ¯u TiÃªn Cao (PHáº¢I Sá»¬A NGAY)

#### 5.1.1 ThÃªm Model: `cong_no_phai_tra`

```python
class CongNoPhaiTra(models.Model):
    _name = 'cong_no_phai_tra'
    _description = 'CÃ´ng ná»£ pháº£i tráº£ (nhÃ¢n viÃªn, nhÃ  cung cáº¥p, v.v)'
    
    name = fields.Char('MÃ£', default='New')
    partner_id = fields.Many2one('res.partner', required=True)
    
    amount = fields.Monetary('Sá»‘ tiá»n gá»‘c', required=True)
    paid_amount = fields.Monetary('ÄÃ£ tráº£', compute='_compute_paid')
    residual = fields.Monetary('CÃ²n ná»£', compute='_compute_residual')
    
    state = fields.Selection([
        ('draft', 'NhÃ¡p'),
        ('open', 'Äang ná»£'),
        ('partial', 'Tráº£ má»™t pháº§n'),
        ('paid', 'ÄÃ£ tráº£ Ä‘á»§'),
        ('cancelled', 'Há»§y'),
    ], default='draft')
    
    # LiÃªn káº¿t vá»›i phiáº¿u chi
    phieu_chi_ids = fields.One2many('phieu_chi', 'cong_no_phai_tra_id')
```

#### 5.1.2 Cáº­p Nháº­t `phieu_chi` Khi Ghi Sá»•

```python
def action_post(self):
    """Ghi sá»• phiáº¿u chi"""
    for rec in self:
        # âœ… THÃŠM: Cáº­p nháº­t cÃ´ng ná»£ pháº£i tráº£
        if rec.loai_chi == 'chi_cong_no' and rec.cong_no_phai_tra_id:
            rec.cong_no_phai_tra_id._update_payment(rec.amount, rec.id)
        
        # âœ… THÃŠM: Cáº­p nháº­t dá»± toÃ¡n chi
        if rec.du_toan_chi_id:
            rec.du_toan_chi_id.write({
                'da_chi_thuc_te': rec.du_toan_chi_id.da_chi_thuc_te + rec.amount
            })
        
        # âœ… THÃŠM: Táº¡o tÃ i sáº£n náº¿u mua sáº¯m
        if rec.loai_chi == 'chi_mua_sam':
            self._create_tai_san_from_purchase(rec)
```

#### 5.1.3 ThÃªm "ÄÃ£ Chi" trong Dá»± ToÃ¡n Chi

```python
# Trong du_toan_chi.py
da_chi_thuc_te = fields.Monetary('ÄÃ£ chi thá»±c táº¿', default=0)
con_lai_chi = fields.Monetary('CÃ²n láº¡i chi', compute='_compute_con_lai_chi')

@api.depends('so_tien_duyet', 'da_chi_thuc_te')
def _compute_con_lai_chi(self):
    for rec in self:
        rec.con_lai_chi = rec.so_tien_duyet - rec.da_chi_thuc_te
```

### 5.2 Æ¯u TiÃªn Trung (NÃŠN Sá»¬A)

#### 5.2.1 HoÃ n Thiá»‡n Module VÄƒn Báº£n

```python
# quan_ly_van_ban/models/van_ban_di.py

class VanBanDi(models.Model):
    _name = 'van_ban_di'
    _description = 'VÄƒn báº£n Ä‘i'
    _inherit = ['mail.thread', 'mail.activity.mixin']
    _order = 'ngay_ban_hanh desc'
    
    ma_van_ban = fields.Char('MÃ£', required=True, unique=True)
    ten_van_ban = fields.Char('TÃªn', required=True)
    
    # ThÃªm cÃ¡c trÆ°á»ng thiáº¿u
    loai_van_ban = fields.Selection([
        ('thong_bao', 'ThÃ´ng bÃ¡o'),
        ('quyet_dinh', 'Quyáº¿t Ä‘á»‹nh'),
        ('hop_dong', 'Há»£p Ä‘á»“ng'),
        ('thoathuan', 'Thá»a thuáº­n'),
        ('chi_thi', 'Chá»‰ thá»‹'),
        ('khac', 'KhÃ¡c'),
    ], required=True)
    
    noi_dung = fields.Html('Ná»™i dung')
    file_dinh_kem = fields.Binary('File', attachment=True)
    
    ngay_ban_hanh = fields.Date('NgÃ y ban hÃ nh', required=True)
    ngay_hieu_luc = fields.Date('NgÃ y hiá»‡u lá»±c')
    
    nguoi_ky = fields.Many2one('res.users', 'NgÆ°á»i kÃ½')
    phong_ban_id = fields.Many2one('phong_ban', 'PhÃ²ng ban phÃ¡t hÃ nh')
    
    state = fields.Selection([
        ('draft', 'NhÃ¡p'),
        ('issued', 'ÄÃ£ ban hÃ nh'),
        ('cancelled', 'ÄÃ£ há»§y'),
    ], default='draft')
    
    # LiÃªn káº¿t vá»›i ngÃ¢n sÃ¡ch, tÃ i sáº£n náº¿u cáº§n
    ngan_sach_id = fields.Many2one('ngan_sach', 'NgÃ¢n sÃ¡ch liÃªn quan')
    tai_san_ids = fields.Many2many('tai_san', 'TÃ i sáº£n liÃªn quan')
```

#### 5.2.2 Thá»‘ng Nháº¥t TÃªn Tráº¡ng ThÃ¡i

Thay táº¥t cáº£ `trang_thai` â†’ `state` vÃ  dÃ¹ng convention duy nháº¥t.

### 5.3 Æ¯u TiÃªn Tháº¥p (CÃ“ THá»‚ Äá»¢)

1. Tá»‘i Æ°u hÃ³a bÃ¡o cÃ¡o (dashboard)
2. ThÃªm lá»‹ch sá»­ thay Ä‘á»•i tráº¡ng thÃ¡i (audit log)
3. ThÃªm phÃª duyá»‡t nhiá»u cáº¥p

---

## VI. DANH SÃCH ISSUES & FIXES

### Issue #1: KhÃ´ng Cáº­p Nháº­t CÃ´ng Ná»£ Khi Chi

**File:** `quanly_thuchi_congno/models/phieu_chi.py`

**DÃ²ng:** action_post()

**Sá»­a:**
```python
def action_post(self):
    for rec in self:
        # ... code cÅ© ...
        
        # THÃŠM: Cáº­p nháº­t cÃ´ng ná»£ pháº£i tráº£
        if rec.loai_chi == 'chi_cong_no' and rec.cong_no_phai_tra_id:
            cong_no = rec.cong_no_phai_tra_id
            cong_no._update_payment(rec.amount, rec.name)
            
            # Cáº­p nháº­t tráº¡ng thÃ¡i cÃ´ng ná»£
            if cong_no.residual <= 0:
                cong_no.state = 'paid'
            elif cong_no.residual < cong_no.amount:
                cong_no.state = 'partial'
```

---

## VII. TÃ“MMá»¨C Yáº¾U Tá» CHÃNH Cáº¦N Cáº¢I THIá»†N

| Yáº¿u Tá»‘ | Tráº¡ng ThÃ¡i | Má»©c Äá»™ NghiÃªm Trá»ng |
|--------|-----------|-------------------|
| LiÃªn káº¿t Phiáº¿u Chi â†” CÃ´ng Ná»£ Pháº£i Tráº£ | âŒ ChÆ°a cÃ³ | ğŸ”´ Cao |
| LiÃªn káº¿t Phiáº¿u Chi â†” Táº¡o TÃ i Sáº£n | âŒ ChÆ°a cÃ³ | ğŸ”´ Cao |
| LiÃªn káº¿t Dá»± ToÃ¡n â†” Thá»±c Táº¿ Chi | âŒ ChÆ°a cÃ³ | ğŸ”´ Cao |
| Kiá»ƒm Tra Tá»•ng PhÃ¢n Bá»• â‰¤ NgÃ¢n SÃ¡ch | âŒ ChÆ°a cÃ³ | ğŸŸ  Trung |
| Module VÄƒn Báº£n QuÃ¡ ÄÆ¡n Giáº£n | âš ï¸ CÆ¡ Báº£n | ğŸŸ  Trung |
| Thá»‘ng Nháº¥t TÃªn Tráº¡ng ThÃ¡i | âŒ ChÆ°a cÃ³ | ğŸŸ¡ Tháº¥p |

---

## VIII. KHUYáº¾N NGHá»Š Vá»€ QUI TRÃŒNH

### Chu Ká»³ Sinh Dá»¯ Liá»‡u - YÃŠU Cáº¦U THá»°C HIá»†N Äáº¦Y Äá»¦

```
[1] Láº­p NgÃ¢n SÃ¡ch
    â†“
[2] PhÃ¢n Bá»• NgÃ¢n SÃ¡ch & Dá»± ToÃ¡n Chi â†’ Duyá»‡t
    â†“
[3] Láº­p Phiáº¿u Chi
    â”œâ”€â†’ KIá»‚M TRA: cÃ²n_lai_chi - amount â‰¥ 0?
    â”œâ”€â†’ KIá»‚M TRA: con_lai_ngan_sach - amount â‰¥ 0?
    â”œâ”€â†’ Náº¿u mua sáº¯m: Táº¡o báº£n ghi TÃ i Sáº£n
    â””â”€â†’ XÃ¡c Nháº­n â†’ Duyá»‡t â†’ Ghi Sá»•
        â””â”€â†’ Cáº¬P NHáº¬T: du_toan_chi.da_chi_thuc_te â†‘
        â””â”€â†’ Cáº¬P NHáº¬T: cong_no_phai_tra.residual â†“
        â””â”€â†’ Cáº¬P NHáº¬T: theo_doi_thuc_hien_ngan_sach
    â†“
[4] Láº­p Phiáº¿u Thu (tá»« CÃ´ng Ná»£ Pháº£i Thu hoáº·c Thanh LÃ½)
    â”œâ”€â†’ XÃ¡c Nháº­n â†’ Ghi Sá»•
    â””â”€â†’ Cáº¬P NHáº¬T: cong_no_phai_thu.residual â†“
    â””â”€â†’ Cáº¬P NHáº¬T: theo_doi_thuc_hien_ngan_sach
    â†“
[5] BÃ¡o CÃ¡o
    â”œâ”€ So sÃ¡nh Dá»± ToÃ¡n vs Thá»±c Táº¿
    â”œâ”€ Cáº£nh bÃ¡o VÆ°á»£t NgÃ¢n SÃ¡ch
    â”œâ”€ CÃ´ng Ná»£ QuÃ¡ Háº¡n
    â””â”€ TÃ¬nh Tráº¡ng TÃ i Sáº£n
```

---

**Káº¾T THÃšC BÃO CÃO**
